---
title: Melanoma immune subtyping
date: 2023-02-05
author: Ieva Kerševičiūtė
---

```{r, include = FALSE, echo = FALSE}
library(data.table)
library(tidyverse)
library(pheatmap)
library(WGCNA)
library(ggpubr)
```

# {.tabset .tabset-pills .unlisted .unnumbered}

## Download the data

The final gene list was formed from:

- classificationGenes.csv
- LBL-10025-02_PanCancer-Pathways-Gene-List.xlsx
- LBL-10043-08_nCounter_PanCancer_Immune_Profiling_Panel_Gene_List.xlsx
- LBL-10498-02_IO_360_Gene_List.xlsx

```{r}
if (!file.exists('output/raw.RDS')) {
  message('Downloading TCGA melanoma z-scores')
  source('R/download.R', chdir = TRUE)
  downloadTCGA()
} else {
  message('TCGA melanoma z-scores already downloaded')
}
```

## Prepare the clinical information

- [Clinical data](http://www.cbioportal.org/study/clinicalData?id=skcm_tcga) was downloaded directly from
  [cBioPortal](www.cbioportal.org) on 7th January, 2022.
- Select a subset of available columns and format them
- Drop data of the samples for which we do not have the clinical information (N = 2)
- Drop non-unique clinical information (N = 9). Note that these samples only had clinical information duplicated
  and a single entry in the count matrix
- From the gene map, drop genes which could not be downloaded (N = 3)
- Make sure all classification genes are in the count matrix

```{r}
raw <- readRDS('output/raw.RDS')

cols <- c('Patient ID', 'Diagnosis Age', 'Overall Survival (Months)', 'Overall Survival Status', 'Sex', 'Patient Weight', 'Patient Height')

key <- fread('data/skcm_tcga_clinical_data.tsv') %>%
  .[ , ..cols ] %>%
  setnames(c('SID', 'Age', 'SurvivalMonths', 'SurvivalStatus', 'Sex', 'Weight', 'Height')) %>%
  .[ , Age := as.numeric(Age) ] %>%
  .[ , SurvivalMonths := as.numeric(SurvivalMonths) ] %>%
  .[ , SurvivalStatus := ifelse(SurvivalStatus == '1:DECEASED', 'Deceased', 'Living') ] %>%
  .[ , SurvivalStatus := factor(SurvivalStatus, levels = c('Living', 'Deceased')) ] %>%
  .[ , Sex := factor(Sex, levels = c('Male', 'Female')) ] %>%
  .[ , Weight := as.numeric(Weight) ] %>%
  .[ , Height := as.numeric(Height) ] %>%
  .[ , BMI := Weight / (Height / 100 * Height / 100) ]

# Drop count data which is not in the sample sheet
message('Will drop ', sum(!(key[ , SID ] %in% rownames(raw$x))), ' clinical entries without count data.') # 2
key <- key[ SID %in% rownames(raw$x) ]

# First, let's keep only unique key
duplicatedSIDs <- key[ duplicated(SID), SID ]
key[ SID %in% duplicatedSIDs ]
stopifnot(raw$x[ duplicatedSIDs, ] %>% nrow == length(duplicatedSIDs)) # make sure only clinical info is duplicated
message('Will drop ', length(duplicatedSIDs), ' non-unique clinical entries.') # 9

key <- key[ !duplicated(SID) ]

# Keep counts of samples with clinical information
raw$x <- raw$x[ match(key[ , SID ], rownames(raw$x)) %>% na.omit, ]
key <- key[ SID %in% rownames(raw$x) ]

stopifnot(nrow(raw$x) == nrow(key))

# Check if all genes in the count matrix
raw$x <- raw$x[ , match(raw$map[ , Symbol ], colnames(raw$x)) %>% na.omit ]
raw$map <- raw$map[ match(colnames(raw$x), Symbol) ]

# Apparently, we did not find data for 3 genes
stopifnot(all(raw$map[ , Symbol ] %in% colnames(raw$x)))

# Check if all classification genes are in the count matrix
classificationGenes <- fread('data/classificationGenes.csv') %>%
  .[ Gene %in% colnames(raw$x) ]

data <- list(
  x = raw$x,
  key = key,
  map = raw$map,
  classificationGenes = classificationGenes
)

lapply(data, dim)

saveRDS(data,'output/data.RDS')
```

```{r, include = FALSE, echo = FALSE}
rm(raw, key, classificationGenes)
```

## Outlier detection

- 199 genes had CV smaller than cutoff = 5; they were removed from further analysis
- No clear outliers detected in hierarchical clustering
- No clear outliers in PCA plots
- After outlier detection, continuing analysis with 1372 genes from 469 samples

### Coefficient of variation (CV)

First step in data preparation is detecting any genes that have small variability among all samples and removing
them. Coefficient of variation shows the extent of variability of data in a sample in relation to the mean of the
population^[1](https://www.investopedia.com/terms/c/coefficientofvariation.asp)^. The smaller the CV, the less dispersed
the data points. In our case, we are looking for high variability between immune groups and small variability within
the group, so we can safely remove any genes that have small overall dispersion in all samples since they do not
separate the samples well and thus will not be detected as significant biomarkers.

$$
c_v = \frac{\sigma}{\mu}
$$

```{r}
data <- readRDS('output/data.RDS')

cvCutoff <- 5
cv <- apply(data$x, 2, \(x) { sd(x) / abs(mean(x)) })

sum(cv < cvCutoff)

data.table(CV = cv) %>%
  .[ CV < 100 ] %>%
  .[ , WillDrop := ifelse(CV < cvCutoff, 'Yes', 'No') %>% factor(levels = c('Yes', 'No')) ] %>%
  ggplot() +
  geom_histogram(aes(x = CV, fill = WillDrop), binwidth = 2, color = 'black') +
  scale_fill_manual(name = 'Will be dropped', values = c('Yes' = 'salmon', 'No' = 'white')) +
  theme_bw(base_size = 9) +
  xlab('Coefficient of variation') +
  ylab('Count')

limit <- max(abs(data$x))

message('Heatmap of gene expression of the genes with small CV')
pheatmap(
  t(data$x[ , which(cv < cvCutoff) ]),
  breaks = seq(from = -limit, to = limit, length.out = 101),
  show_colnames = FALSE,
  show_rownames = FALSE)

data$x <- data$x[ , which(cv >= cvCutoff) ]
data$map <- data$map[ Symbol %in% colnames(data$x) ]
data$classificationGenes <- data$classificationGenes[ Gene %in% colnames(data$x) ]
```

### Hierarchical clustering

Hierarchical clustering can be used to visually detect any outliers in the data. Using euclidean method to calculate
the distances between samples.

The dendrogram does not show any clear outliers (they would be seen as separated branches).

```{r}
distances <- dist(data$x, method = 'euclidean')
hClusters <- hclust(distances)

colors <- data$key[ , list(
  Sex = labels2colors(Sex),
  SurvivalStatus = labels2colors(SurvivalStatus)
) ]

plotDendroAndColors(hClusters, colors, dendroLabels = FALSE)
```

### Principal Component Analysis

PCA was used to check if there is any global trends towards the differences between sexes. No such trends are visible
from the first 3 components. Also, these components do not show any outliers.

```{r}
pca <- prcomp(data$x, scale = TRUE, center = TRUE)$x[ , 1:3 ]

pcaPlots <- list()
counter <- 1
for (i in 1:(ncol(pca) - 1)) {
  for (j in i:ncol(pca)) {
    if (i == j) next

    xlabel <- colnames(pca)[ i ]
    ylabel <- colnames(pca)[ j ]

    pcaPlots[[ counter ]] <- pca[ , c(i, j) ] %>%
      data.table(keep.rownames = 'SID') %>%
      setnames(c('SID', 'x', 'y')) %>%
      merge(data$key[ , list(SID, Sex) ], by = 'SID') %>%
      ggplot() +
      geom_point(aes(x = x, y = y, color = Sex), size = 1.5, alpha = 0.75) +
      ylab(ylabel) +
      xlab(xlabel) +
      theme_bw(base_size = 9)

    counter <- counter + 1
  }
}

ggarrange(plotlist = pcaPlots,
          common.legend = TRUE,
          legend = 'top',
          ncol = 3)

lapply(data, dim)
saveRDS(data, 'output/dataNoOutlier.RDS')
```

```{r, include = FALSE, echo = FALSE}
rm(cv, cvCutoff, limit, distances, hClusters, colors, pca, pcaPlots, i, j, xlabel, ylabel, counter, data)
```
